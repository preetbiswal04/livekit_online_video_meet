<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams Pro - LiveKit</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --teams-purple: #603ab8;
            --teams-bg: #F5F5F5;
            --sidebar-bg: #EBEBEB;
            --sidebar-active: #FFFFFF;
            --text-main: #242424;
            --text-muted: #616161;
            --border-color: #0c0c0c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--teams-bg);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        nav#sidebar {
            width: 72px;
            background: #333449;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 15px;
            color: #C8C8E1;
            flex-shrink: 0;
        }

        .nav-item {
            width: 100%;
            height: 56px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 10px;
            gap: 4px;
            transition: 0.2s;
            position: relative;
        }

        .nav-item i {
            font-size: 18px;
        }

        .nav-item:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            color: var(--teams-purple);
            background: white;
            border-left: 3px solid var(--teams-purple);
        }

        .nav-item.active i {
            color: var(--teams-purple);
        }

        /* Main Shell */
        #app-shell {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        /* Sidebar Side-Panel (Chat/People) */
        #side-panel {
            width: 300px;
            background: #1A1A1A;
            /* Black background */
            color: #FFFFFF;
            /* White font */
            border-left: 1px solid #333;
            display: none;
            flex-direction: column;
            height: 100%;
        }

        #side-panel.active {
            display: flex;
        }

        .panel-header {
            padding: 16px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h4 {
            color: white;
        }

        .panel-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Chat Styles */
        #chat-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .msg {
            font-size: 13px;
            padding: 8px;
            border-radius: 4px;
            background: #2D2D2D;
            /* Dark grey for messages */
            color: white;
            max-width: 90%;
        }

        .msg.self {
            align-self: flex-end;
            background: #3D3D3D;
        }

        .msg-sender {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 2px;
            color: #C8C8E1;
        }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid #333;
            display: flex;
            gap: 8px;
            background: #1A1A1A;
        }

        .chat-input-area input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #444;
            background: #2D2D2D;
            color: white;
            border-radius: 4px;
            outline: none;
        }

        /* Header */
        header {
            height: 48px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .search-bar {
            background: #F3F2F1;
            border-radius: 4px;
            padding: 4px 12px;
            width: 400px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .search-bar input {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            font-size: 12px;
        }

        /* Content Area */
        main#content {
            flex-grow: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Views */
        .view {
            display: none;
            height: 100%;
        }

        .view.active {
            display: block;
        }

        /* Home View Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .card h3 {
            margin-bottom: 12px;
            font-size: 18px;
        }

        .card p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--teams-purple);
            color: white;
        }

        .btn-primary:hover {
            background: #3b429e;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #D1D1D1;
        }

        .btn-secondary:hover {
            background: #F3F2F1;
        }

        /* Meeting View */
        #meeting-view {
            background: #1F1F1F;
            color: white;
            padding: 0;
            position: relative;
            overflow: hidden;
            flex-grow: 1;
        }

        #meeting-view.active {
            display: flex;
            flex-direction: row;
        }

        .meeting-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .meeting-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: rgba(0, 0, 0, 0.4);
        }

        #video-grid {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            padding: 12px;
            align-content: center;
            transition: all 0.3s ease;
        }

        /* Screen Share Layout */
        #video-grid.screen-share-active {
            grid-template-columns: 1fr 300px;
            grid-template-rows: auto;
            /* Let rows grow */
            grid-auto-rows: min-content;
            align-content: start;
            overflow-y: auto;
            /* Allow scrolling */
        }

        .participant-tile {
            background: #2F2F2F;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #3F3F3F;
        }

        .participant-tile video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant-tile.screen-share {
            /* In grid mode, it behaves normally or spans 2 cols if set */
            /* In active mode, JS will ensure it is the first child */
            background: #000;
        }

        #video-grid.screen-share-active .participant-tile.screen-share {
            grid-column: 1 / 2;
            /* Sticky so it stays in view while scrolling sidebar */
            position: sticky;
            top: 0;
            height: calc(100vh - 140px);
            grid-row: 1 / span 50;
            z-index: 5;
        }

        #video-grid.screen-share-active .participant-tile:not(.screen-share) {
            height: 200px;
            grid-column: 2 / 3;
        }

        .participant-tile.screen-share video {
            object-fit: contain;
            background: #000;
        }

        .fullscreen-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
        }

        .participant-tile:hover .fullscreen-btn {
            opacity: 1;
        }

        .participant-tile .name-tag {
            position: absolute !important;
            bottom: 12px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
            color: white;
            font-weight: 500;
            z-index: 100 !important;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .meeting-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            height: 64px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(31, 31, 31, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: #3D3D3D;
            color: white;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .tool-btn:hover {
            background: #505050;
        }

        .tool-btn.danger {
            background: #C4314B;
        }

        .tool-btn.danger:hover {
            background: #A7283F;
        }

        /* Log Utility */
        #log-overlay {
            display: none;
            /* Hidden by default */
            position: fixed;
            bottom: 90px;
            right: 10px;
            width: 300px;
            max-height: 150px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-size: 10px;
            padding: 8px;
            border-radius: 4px;
            overflow-y: auto;
            pointer-events: none;
            opacity: 0.6;
            z-index: 1000;
        }

        /* Input Modal */
        #join-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            margin-bottom: 16px;
            font-size: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Profile Dropdown */
        .profile-container {
            position: relative;
            cursor: pointer;
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4B53BC;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 200px;
            z-index: 3000;
        }

        .profile-dropdown.active {
            display: block;
        }

        .profile-info {
            padding: 12px 16px;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
        }

        .profile-item {
            display: block;
            padding: 10px 16px;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .profile-item:hover {
            background: #f5f5f5;
        }

        .profile-item.logout {
            color: #C4314B;
        }

        /* Eval Styles */
        .eval-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 4px;
        }

        .eval-item:hover {
            background: #f0f0f0;
        }

        .eval-item.active {
            background: #eef2ff;
            border-left: 3px solid var(--teams-purple);
        }

        .score-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .score-high {
            background: #28a745;
        }

        .score-med {
            background: #ffc107;
            color: #333;
        }

        .score-low {
            background: #dc3545;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="nav-item active" onclick="switchView('home')">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-bell"></i>
            <span>Activity</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-comment-alt"></i>
            <span>Chat</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-users"></i>
            <span>Teams</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Calendar</span>
        </div>
        <div class="nav-item">
            <i class="fas fa-phone-alt"></i>
            <span>Calls</span>
        </div>
        <div class="nav-item" onclick="switchView('dashboard')">
            <i class="fas fa-clipboard-check"></i>
            <span>Evaluations</span>
        </div>
    </nav>

    <div id="app-shell">
        <header>
            <div style="font-weight: bold; color: var(--teams-purple); font-size: 18px;"> Teams Meetings <span
                    style="font-weight: normal; color: #666; font-size: 14px; margin-left: 8px;">Room</span></div>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search for people or files...">
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="profile-container" onclick="toggleProfileMenu(event)">
                    <div class="profile-avatar">
                        {{ username[0] | upper }}
                    </div>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <div class="profile-info">Signed in as <strong>{{ username }}</strong></div>
                        <a href="/api/logout" class="profile-item logout">
                            <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i> Sign out
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <main id="content">

            <!-- DASHBOARD VIEW -->
            <div id="dashboard-view" class="view">
                <div style="margin-bottom: 20px;">
                    <h2 style="font-size: 20px;">Candidate Evaluations</h2>
                    <p style="color: var(--text-muted); font-size: 13px;">Review AI-generated feedback for past
                        interviews.</p>
                </div>

                <div style="display: flex; height: calc(100vh - 160px); gap: 20px;">
                    <!-- Left: List -->
                    <div
                        style="width: 300px; background: white; border: 1px solid #ddd; border-radius: 8px; display: flex; flex-direction: column;">
                        <div
                            style="padding: 12px; border-bottom: 1px solid #eee; background: #fafafa; border-radius: 8px 8px 0 0;">
                            <input type="text" placeholder="Search candidates..." id="eval-search"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                                onkeyup="filterEvaluations()">
                        </div>
                        <div id="eval-list" style="flex-grow: 1; overflow-y: auto; padding: 8px;">
                            <!-- Items injected via JS -->
                            <div style="text-align: center; padding: 20px; color: #999; font-size: 13px;">Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Right: Details -->
                    <div id="eval-details"
                        style="flex-grow: 1; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 24px; overflow-y: auto;">
                        <div
                            style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; flex-direction: column;">
                            <i class="fas fa-chart-bar" style="font-size: 40px; margin-bottom: 10px; opacity: 0.3;"></i>
                            <p>Select a candidate to view the full report</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="home-view" class="view active">
                <div style="margin-bottom: 30px;">
                    <h1 style="font-size: 24px; margin-bottom: 8px;">Hello Welcome back, {{ username }}</h1>
                    <p style="color: var(--text-muted);">Stay connected with your team and get more done.</p>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <i class="fas fa-video"
                            style="font-size: 24px; color: var(--teams-purple); margin-bottom: 16px;"></i>
                        <h3>Instant Meeting</h3>
                        <p>Start a new meeting and invite others to join instantly.</p>
                        <button class="btn btn-primary" onclick="showJoinModal('create')">Meet now</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-plus-square" style="font-size: 24px; color: #28a745; margin-bottom: 16px;"></i>
                        <h3>Join Room</h3>
                        <p>Enter a room name or meeting ID to join an existing session.</p>
                        <button class="btn btn-secondary" onclick="showJoinModal('join')">Join with ID</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-file-invoice"
                            style="font-size: 24px; color: #17a2b8; margin-bottom: 16px;"></i>
                        <h3>AI Interview Prep</h3>
                        <p>Upload your Resume and paste the JD to generate targeted questions and start an AI-led
                            interview.</p>
                        <form id="uploadForm" style="display: flex; flex-direction: column; gap: 8px;">
                            <input type="file" id="resumeInput" accept=".pdf,.docx" class="btn btn-secondary"
                                style="width: 100%; border: 1px dotted #ccc;">
                            <textarea id="jdInput" placeholder="Paste Job Description here..."
                                style="font-size: 12px; padding: 8px; height: 60px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                            <button type="submit" class="btn btn-primary" id="prep-btn">Prepare Interview</button>
                        </form>
                    </div>
                    <div class="card">
                        <i class="fas fa-clock" style="font-size: 24px; color: #ffc107; margin-bottom: 16px;"></i>
                        <h3>Recent Rooms</h3>
                        <div id="rooms-list" style="font-size: 13px; color: #666;">
                            Loading active rooms...
                        </div>
                    </div>
                </div>
            </div>


            <div id="meeting-view" class="view">
                <div class="meeting-main">
                    <div class="meeting-header">
                        <div>
                            <span id="meeting-title" style="font-weight: 600;">Meeting: Unknown</span>
                            <span style="font-size: 13px; color: #aaa; margin-left: 10px;">(You: {{ username
                                }})</span>
                            <span style="margin-left: 12px; font-size: 12px; color: #aaa;"
                                id="meeting-duration">00:00</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary"
                                style="background: transparent; color: white; border-color: #555;"
                                onclick="copyShareLink()">
                                <i class="fas fa-link"></i> Copy Link
                            </button>
                        </div>
                    </div>

                    <div id="video-grid">

                    </div>

                    <div class="meeting-controls">
                        <button class="tool-btn" id="mic-btn" onclick="toggleMic()" title="Mute/Unmute"><i
                                class="fas fa-microphone"></i></button>
                        <button class="tool-btn" id="cam-btn" onclick="toggleCam()" title="Camera On/Off"><i
                                class="fas fa-video"></i></button>
                        <button class="tool-btn" id="share-screen-btn" onclick="toggleScreenShare()"
                            title="Share Screen"><i class="fas fa-arrow-up-from-bracket"></i></button>
                        <button class="tool-btn" id="chat-toggle-btn" onclick="toggleChat()" title="Chat"><i
                                class="fas fa-message"></i></button>
                        <button class="tool-btn" id="people-toggle-btn" onclick="togglePeople()" title="People"><i
                                class="fas fa-user-group"></i></button>
                        <button class="tool-btn" id="more-btn" title="More"><i class="fas fa-ellipsis"></i></button>
                        <button class="tool-btn danger" onclick="leaveMeeting()" title="Leave Meeting"
                            style="width: 64px; border-radius: 4px; margin-left: 20px;">
                            <i class="fas fa-phone-slash"></i> <span
                                style="font-size: 12px; margin-left: 5px; font-weight: bold;">Leave</span>
                        </button>
                    </div>
                </div>


                <div id="side-panel">
                    <div class="panel-header">
                        <h4 id="panel-title">Chat</h4>
                        <i class="fas fa-times" style="cursor: pointer;" onclick="closeSidePanel()"></i>
                    </div>


                    <div id="chat-container">
                        <div class="panel-content" id="chat-content">
                            <div id="chat-messages"></div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" id="chat-input" placeholder="Type a message..."
                                onkeypress="if(event.key === 'Enter') sendChatMessage()">
                            <i class="fas fa-paper-plane"
                                style="color: var(--teams-purple); cursor: pointer; align-self: center;"
                                onclick="sendChatMessage()"></i>
                        </div>
                    </div>


                    <div id="people-container" style="display: none;">
                        <div class="panel-content">
                            <div id="participants-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals & Overlays -->
    <div id="join-modal">
        <div class="modal-content">
            <h2 id="modal-title">Join Meeting</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 5px;">Please enter the room name to continue.</p>
            <p style="font-size: 14px; color: var(--teams-purple); margin-bottom: 20px; font-weight: bold;">
                <i class="fas fa-user-circle"></i> Joining as: {{ username }}
                <a href="/api/logout"
                    style="font-size: 12px; color: #666; font-weight: normal; margin-left: 10px; text-decoration: underline;">(Switch
                    Account)</a>
            </p>
            <input type="text" id="room-input" placeholder="e.g. general-meeting">
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn btn-secondary" onclick="hideJoinModal()">Cancel</button>
                <button class="btn btn-primary" id="modal-action-btn" onclick="handleModalAction()">Continue</button>
            </div>
        </div>
    </div>

    <div id="log-overlay"></div>

    <script>
        const LK = window.LivekitClient || window.LiveKitClient;
        let activeRoom = null;
        let currentView = 'home';
        let modalMode = 'join';

        function toggleProfileMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('profile-dropdown');
            menu.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            const menu = document.getElementById('profile-dropdown');
            if (menu) menu.classList.remove('active');
        });

        // --- Utility ---
        function log(msg) {
            console.log(msg);
            const overlay = document.getElementById('log-overlay');
            const entry = document.createElement('div');
            entry.innerText = `> ${msg}`;
            overlay.prepend(entry);
        }

        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewId}-view`).classList.add('active');

            // Adjust main content padding
            const mainContent = document.getElementById('content');
            if (viewId === 'meeting') {
                mainContent.style.padding = '0';
            } else {
                mainContent.style.padding = '24px';
            }

            // Update Sidebar indicator
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (viewId === 'home') document.querySelector('.nav-item').classList.add('active');

            currentView = viewId;
        }

        // --- API Integration ---
        async function fetchRooms() {
            try {
                const res = await fetch('/api/rooms');
                const rooms = await res.json();
                const listEl = document.getElementById('rooms-list');
                listEl.innerHTML = rooms.map(r =>
                    `<div style="margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span>${r.name}</span>
                        <a href="javascript:void(0)" onclick="joinRoom('${r.name}')" style="color: var(--teams-purple); text-decoration:none;">Join</a>
                    </div>`
                ).join('');
            } catch (e) {
                log("Failed to fetch rooms: " + e.message);
            }
        }

        // --- Modal ---
        function showJoinModal(mode) {
            modalMode = mode;
            document.getElementById('modal-title').innerText = mode === 'create' ? 'Start a New Meeting' : 'Join Meeting';
            document.getElementById('modal-action-btn').innerText = mode === 'create' ? 'Start' : 'Join';
            document.getElementById('join-modal').style.display = 'flex';

            // Suggest a name for 'create'
            if (mode === 'create') {
                document.getElementById('room-input').value = "meeting-" + Math.floor(Math.random() * 1000);
            }
        }

        function hideJoinModal() {
            document.getElementById('join-modal').style.display = 'none';
        }

        async function handleModalAction() {
            const roomName = document.getElementById('room-input').value.trim();
            if (!roomName) return alert("Please enter a room name");
            hideJoinModal();
            joinRoom(roomName);
        }

        // --- Meeting Logic ---
        async function joinRoom(roomName) {
            log(`Transitioning to room: ${roomName}`);
            switchView('meeting');
            document.getElementById('meeting-title').innerText = `Meeting: ${roomName}`;

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log("WARNING: Camera/Mic access requires HTTPS or localhost.");
                alert("Browser Error: Camera access is blocked on insecure connections. Please use http://localhost:5000");
            }

            try {
                const LK = window.LivekitClient || window.LiveKitClient || window.LiveKit;
                if (!LK) throw new Error("LiveKit SDK not loaded. Check internet/CDN.");

                const userName = "user-" + Math.floor(Math.random() * 1000);
                log(`Fetching token for ${userName}...`);

                const res = await fetch(`/get-token/${roomName}/${userName}`);
                if (!res.ok) throw new Error(`Backend error: ${res.status}`);
                const data = await res.json();

                log(`Connecting to ${data.url}...`);
                activeRoom = new LK.Room();

                // Event Handling
                activeRoom.on('connectionStateChanged', (state) => log("Connection state: " + state));
                activeRoom.on('trackSubscribed', (track, pub, part) => {
                    log(`Subscribed: ${track.kind} from ${part.identity}`);
                    renderTrack(track, part);
                });
                activeRoom.on('trackUnsubscribed', (track, pub, part) => {
                    track.detach().forEach(el => el.remove());
                    // Cleanup tile
                    const isScreen = track.source === 'screen_share';
                    const safeIdentity = part.identity.replace(/[^a-zA-Z0-9-_]/g, '-');
                    const id = `p-${safeIdentity}${isScreen ? '-screen' : ''}`;
                    const el = document.getElementById(id);
                    if (el && track.kind === 'video') el.remove();
                    updateLayout();
                });
                activeRoom.on('dataReceived', (payload, participant) => {
                    const text = new TextDecoder().decode(payload);
                    const sender = participant ? participant.identity : "Unknown";
                    console.log(`[DATA] Received from ${sender}:`, text);

                    // Robust transcript detection: check for "Transcript (" prefix or if it's from a known agent
                    const isTranscript = text.startsWith("Transcript (") ||
                        sender.toLowerCase().includes('agent') ||
                        sender.toLowerCase().includes('transcription');

                    if (isTranscript) {
                        // Clean up the text if it has the prefix
                        let displayMsg = text;
                        if (text.startsWith("Transcript (")) {
                            // Extract just the part after the first colon if possible
                            const colonIndex = text.indexOf("):");
                            if (colonIndex !== -1) {
                                displayMsg = text.substring(colonIndex + 2).trim();
                            }
                        }
                        appendChatMessage(sender, displayMsg, false, true);
                    } else {
                        appendChatMessage(sender, text);
                    }
                });
                activeRoom.on('participantConnected', (participant) => {
                    log(`Participant connected: ${participant.identity}`);
                    updateParticipantList();
                });
                activeRoom.on('participantDisconnected', (part) => {
                    log(`Participant disconnected: ${part.identity}`);
                    updateParticipantList();
                    const safeIdentity = part.identity.replace(/[^a-zA-Z0-9-_]/g, '-');
                    const el = document.getElementById(`p-${safeIdentity}`);
                    if (el) el.remove();
                    const screenEl = document.getElementById(`p-${safeIdentity}-screen`);
                    if (screenEl) screenEl.remove();

                    if (part.identity === activeRoom.localParticipant.identity) {
                        alert("You have been disconnected. This often happens if you open the same account in another tab.");
                    }
                });

                activeRoom.on('disconnected', (reason) => {
                    log('Room disconnected: ' + reason);
                    // Reason 2 is duplicate identity
                    if (reason == 2 || reason === 'duplicate_identity') {
                        alert("CRITICAL ERROR: You are logged in as the SAME USER in two tabs.\n\nPlease create a DIFFERENT account in Incognito mode to test video.");
                    } else {
                        alert(`Disconnected: ${reason}`);
                    }
                    leaveMeeting();
                });

                // --- AUTO MUTE LOGIC WITH DELAY ---
                let unmuteTimeout = null;
                const UNMUTE_DELAY_MS = 1200; // 1.5 seconds delay

                activeRoom.on(LK.RoomEvent.ActiveSpeakersChanged, (speakers) => {
                    const agentSpeaking = speakers.some(p => p.identity.toLowerCase().includes('agent') || p.identity.toLowerCase().includes('interviewer'));

                    if (agentSpeaking) {
                        if (unmuteTimeout) { clearTimeout(unmuteTimeout); unmuteTimeout = null; }
                        if (activeRoom.localParticipant.isMicrophoneEnabled) {
                            console.log("Agent speaking - Muting user");
                            activeRoom.localParticipant.setMicrophoneEnabled(false);
                            const btn = document.getElementById('mic-btn');
                            if (btn) { btn.innerHTML = '<i class="fas fa-microphone-slash"></i>'; btn.style.background = '#C4314B'; }
                        }
                    } else {
                        if (!activeRoom.localParticipant.isMicrophoneEnabled && !unmuteTimeout) {
                            console.log(`Agent stopped - Waiting ${UNMUTE_DELAY_MS}ms...`);
                            unmuteTimeout = setTimeout(() => {
                                activeRoom.localParticipant.setMicrophoneEnabled(true);
                                const btn = document.getElementById('mic-btn');
                                if (btn) { btn.innerHTML = '<i class="fas fa-microphone"></i>'; btn.style.background = '#3D3D3D'; }
                                unmuteTimeout = null;
                            }, UNMUTE_DELAY_MS);
                        }
                    }
                });


                await activeRoom.connect(data.url, data.token);
                log("Connected!");
                updateParticipantList();

                // Render existing participants (CRITICAL for visibility)
                activeRoom.remoteParticipants.forEach(participant => {
                    participant.trackPublications.forEach(pub => {
                        if (pub.isSubscribed && pub.track) {
                            log(`Rendering existing track ${pub.track.kind} for ${participant.identity}`);
                            renderTrack(pub.track, participant);
                        }
                    });
                });

                // Fetch and display chat history
                await fetchChatHistory(roomName);

                // Try to enable camera and mic, but fall back to mic-only if camera fails
                try {
                    await activeRoom.localParticipant.enableCameraAndMicrophone();
                    log("Camera and Microphone enabled.");
                } catch (e) {
                    log("Failed to enable Camera/Mic: " + e.message);
                    log("Attempting to join with Microphone only...");
                    try {
                        await activeRoom.localParticipant.setMicrophoneEnabled(true);
                        log("Microphone enabled. Camera skipped due to hardware/permission error.");
                        alert("Camera Error: " + e.message + "\n\nDon't worry, you have joined with Audio Only.");
                    } catch (micErr) {
                        log("CRITICAL: Failed to enable Microphone as well: " + micErr.message);
                        alert("Hardware Error: Could not access Camera or Microphone. Please check your browser permissions or hardware connection.");
                    }
                }

                // Render self only if camera was successfully enabled
                const camPub = activeRoom.localParticipant.getTrackPublication(LK.Track.Source.Camera);
                if (camPub && camPub.videoTrack) {
                    renderTrack(camPub.videoTrack, activeRoom.localParticipant, true);
                }

            } catch (err) {
                log("Error joining: " + err.message);
                console.error("Full join error:", err);
                alert("Could not join meeting: " + err.message);
                leaveMeeting();
            }
        }

        async function fetchChatHistory(roomName) {
            try {
                const res = await fetch(`/api/history/${roomName}`);
                if (!res.ok) throw new Error("Failed to fetch history");
                const messages = await res.json();

                const container = document.getElementById('chat-messages');
                // Clear existing only if not appending (but here we just joined so it should be empty or we might want to preserve invalid states? usually clear)
                container.innerHTML = '';

                messages.forEach(msg => {
                    const isSelf = activeRoom.localParticipant && msg.sender === activeRoom.localParticipant.identity;
                    // For history, we don't know if 'isSelf' is reliably true because we might have rejoined with a different identity if random. 
                    // But if we assume identity persistence, we check. 
                    // Since random ID is used in this demo code: "user-" + Math.floor... we probably won't match. 
                    // So just display as is.

                    appendChatMessage(msg.sender, msg.text, false, msg.is_transcript);
                });

                if (messages.length > 0) log(`Loaded ${messages.length} past messages.`);
            } catch (e) {
                log("Could not load history: " + e.message);
            }
        }

        function renderTrack(track, participant, isLocal = false) {
            if (track.kind !== 'video') {
                if (track.kind === 'audio') {
                    const el = track.attach();
                    document.body.appendChild(el);
                    el.play().catch(err => {
                        console.error("Audio playback error:", err);
                        log("Audio Autoplay blocked? Interact with page.");
                    });
                }
                return;
            }

            const isScreen = track.source === 'screen_share';
            const safeIdentity = participant.identity.replace(/[^a-zA-Z0-9-_]/g, '-');
            const id = `p-${safeIdentity}${isScreen ? '-screen' : ''}`;

            let tile = document.getElementById(id);
            if (!tile) {
                tile = document.createElement('div');
                tile.id = id;
                tile.className = 'participant-tile';
                if (isScreen) {
                    tile.classList.add('screen-share');
                    // Removed grid-column style as CSS now handles it
                }

                // Fullscreen button
                const fsBtn = document.createElement('button');
                fsBtn.className = 'fullscreen-btn';
                fsBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fsBtn.title = "Toggle Fullscreen";
                fsBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (!document.fullscreenElement) {
                        tile.requestFullscreen().catch(err => console.error(err));
                    } else {
                        document.exitFullscreen();
                    }
                };
                tile.appendChild(fsBtn);

                const nameTag = document.createElement('div');
                nameTag.className = 'name-tag';
                nameTag.innerText = (isLocal ? 'You' : participant.identity) + (isScreen ? ' (Screen)' : '');
                tile.appendChild(nameTag);

                document.getElementById('video-grid').prepend(tile);
            }

            const videoEl = track.attach();
            videoEl.onplay = () => log(`Video playing for ${participant.identity} (${track.kind})`);
            videoEl.onerror = (e) => log(`Video error for ${participant.identity}: ${e.target.error.message}`);
            if (isLocal && !isScreen) videoEl.style.transform = "scaleX(-1)";

            const existing = tile.querySelector('video');
            if (existing) existing.remove();

            tile.appendChild(videoEl);

            // Ensure name tag and fullscreen button are ON TOP by re-appending them
            const nameTag = tile.querySelector('.name-tag');
            if (nameTag) tile.appendChild(nameTag);

            const fsBtn = tile.querySelector('.fullscreen-btn');
            if (fsBtn) tile.appendChild(fsBtn);

            // Update layout after adding track
            updateLayout();
        }

        function updateLayout() {
            const grid = document.getElementById('video-grid');
            const screenShare = grid.querySelector('.screen-share');

            if (screenShare) {
                grid.classList.add('screen-share-active');
                // Move screen share to start so it takes the main slot
                grid.prepend(screenShare);
            } else {
                grid.classList.remove('screen-share-active');
            }
        }

        // --- Side Panel Logic (Chat & People) ---
        let activePanelType = null; // 'chat' or 'people'

        function toggleChat(force) {
            if (activePanelType === 'chat' && force !== true) {
                closeSidePanel();
            } else {
                openSidePanel('chat');
            }
        }

        function togglePeople() {
            if (activePanelType === 'people') {
                closeSidePanel();
            } else {
                openSidePanel('people');
                updateParticipantList();
            }
        }

        function openSidePanel(type) {
            activePanelType = type;
            const panel = document.getElementById('side-panel');
            const title = document.getElementById('panel-title');
            const chatCont = document.getElementById('chat-container');
            const peopleCont = document.getElementById('people-container');
            const chatBtn = document.getElementById('chat-toggle-btn');
            const peopleBtn = document.getElementById('people-toggle-btn');

            panel.classList.add('active');

            if (type === 'chat') {
                title.innerText = "Chat";
                chatCont.style.display = 'flex';
                chatCont.style.flexDirection = 'column';
                chatCont.style.height = 'calc(100% - 60px)';
                peopleCont.style.display = 'none';

                chatBtn.style.color = 'var(--teams-purple)';
                chatBtn.style.background = 'white';
                peopleBtn.style.color = 'white';
                peopleBtn.style.background = '#3D3D3D';
            } else {
                title.innerText = "Participants";
                chatCont.style.display = 'none';
                peopleCont.style.display = 'block';

                peopleBtn.style.color = 'var(--teams-purple)';
                peopleBtn.style.background = 'white';
                chatBtn.style.color = 'white';
                chatBtn.style.background = '#3D3D3D';
            }
        }

        function closeSidePanel() {
            activePanelType = null;
            document.getElementById('side-panel').classList.remove('active');

            const chatBtn = document.getElementById('chat-toggle-btn');
            const peopleBtn = document.getElementById('people-toggle-btn');

            chatBtn.style.color = 'white';
            chatBtn.style.background = '#3D3D3D';
            peopleBtn.style.color = 'white';
            peopleBtn.style.background = '#3D3D3D';
        }

        function updateParticipantList() {
            if (!activeRoom) return;
            const container = document.getElementById('participants-list');
            if (!container) return;

            const participants = [
                activeRoom.localParticipant,
                ...Array.from(activeRoom.remoteParticipants.values())
            ];

            container.innerHTML = participants.map(p => {
                const isLocal = p === activeRoom.localParticipant;
                const identity = p.identity || "Unknown";
                const safeIdentity = identity.replace(/[^a-zA-Z0-9-_]/g, '-');
                const isAgent = identity.toLowerCase().includes('agent') || identity.toLowerCase().includes('interviewer');

                return `
                    <div class="participant-row" style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: ${isAgent ? '#444' : 'var(--teams-purple)'}; color: white; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold;">
                            ${identity.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 14px;">${identity}${isLocal ? ' (You)' : ''}</div>
                            <div style="font-size: 11px; color: #666;">${isAgent ? 'AI Assistant' : 'Participant'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !activeRoom) return;

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                await activeRoom.localParticipant.publishData(data, { reliable: true });

                // Save to Backend
                fetch('/api/save-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room: activeRoom.name,
                        sender: activeRoom.localParticipant.identity,
                        text: text
                    })
                }).catch(e => console.error("Failed to save message:", e));

                appendChatMessage("You", text, true);
                input.value = '';
            } catch (e) {
                log("Failed to send chat: " + e.message);
            }
        }

        function appendChatMessage(sender, text, isSelf = false, isTranscript = false) {
            const container = document.getElementById('chat-messages');
            const msgEl = document.createElement('div');
            msgEl.className = `msg ${isSelf ? 'self' : ''}`;
            if (isTranscript) {
                msgEl.style.background = "#2D2D3A";
                msgEl.style.borderLeft = "3px solid var(--teams-purple)";
                msgEl.style.fontStyle = "italic";
            }
            msgEl.innerHTML = `
                <div class="msg-sender" style="${isTranscript ? 'color: var(--teams-purple)' : ''}">${sender}</div>
                <div class="msg-text">${text}</div>
            `;
            container.appendChild(msgEl);
            document.getElementById('chat-content').scrollTop = document.getElementById('chat-content').scrollHeight;
        }

        // --- Screen Share ---
        async function toggleScreenShare() {
            if (!activeRoom) return;
            const isEnabled = activeRoom.localParticipant.isScreenShareEnabled;

            try {
                await activeRoom.localParticipant.setScreenShareEnabled(!isEnabled);
                const btn = document.getElementById('share-screen-btn');
                btn.style.background = !isEnabled ? 'var(--teams-purple)' : '#3D3D3D';
                btn.style.color = !isEnabled ? 'white' : 'white';

                log(!isEnabled ? "Screen sharing started" : "Screen sharing stopped");
            } catch (e) {
                log("Screen share error: " + e.message);
                alert("Could not share screen: " + e.message);
            }
        }

        async function leaveMeeting() {
            if (activeRoom) {
                await activeRoom.disconnect();
                activeRoom = null;
            }
            document.getElementById('video-grid').innerHTML = '';
            switchView('home');
            log("Left meeting.");
        }

        async function toggleMic() {
            if (!activeRoom) return;
            const enabled = activeRoom.localParticipant.isMicrophoneEnabled;
            try {
                await activeRoom.localParticipant.setMicrophoneEnabled(!enabled);
                const btn = document.getElementById('mic-btn');
                btn.innerHTML = !enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
                btn.style.background = !enabled ? '#3D3D3D' : '#C4314B';
            } catch (e) {
                log("Failed to toggle mic: " + e.message);
                alert("Microphone Error: " + e.message);
            }
        }

        function toggleCam() {
            if (!activeRoom) return;
            const enabled = activeRoom.localParticipant.isCameraEnabled;
            activeRoom.localParticipant.setCameraEnabled(!enabled);
            const btn = document.getElementById('cam-btn');
            btn.innerHTML = !enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            btn.style.background = !enabled ? '#3D3D3D' : '#C4314B';
        }

        function copyShareLink() {
            const roomName = document.getElementById('meeting-title').innerText.replace('Meeting: ', '');
            const url = `${window.location.origin}${window.location.pathname}?room=${roomName}`;
            navigator.clipboard.writeText(url).then(() => alert("Meeting link copied!"));
        }

        // --- Navigation & Dashboard ---
        function switchView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewId}-view`).classList.add('active');

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.innerText.toLowerCase().includes(viewId)) item.classList.add('active');
                else item.classList.remove('active');
            });

            // Trigger dashboard load
            if (viewId === 'dashboard') {
                loadEvaluations();
            }
        }

        let allEvaluations = [];

        async function loadEvaluations() {
            const listContainer = document.getElementById('eval-list');
            listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading...</div>';

            try {
                const res = await fetch('/api/evaluations');
                const data = await res.json();

                if (data.error) {
                    listContainer.innerHTML = `<div style="padding:10px; color:red;">Error: ${data.error}</div>`;
                    return;
                }

                allEvaluations = data;
                renderEvalList(allEvaluations);
            } catch (e) {
                listContainer.innerHTML = `<div style="padding:10px; color:red;">Failed to load: ${e.message}</div>`;
            }
        }

        function renderEvalList(evals) {
            const listContainer = document.getElementById('eval-list');
            if (evals.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No evaluations found.</div>';
                return;
            }

            listContainer.innerHTML = evals.map((item, index) => {
                let scoreColor = '#666';
                if (item.overall_score >= 8) scoreColor = '#28a745';
                else if (item.overall_score >= 5) scoreColor = '#ffc107';
                else scoreColor = '#dc3545';

                return `
                <div class="eval-item" onclick="showEvalDetails(${index})">
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${item.candidate_name}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 11px; color: #666;">${new Date(item.timestamp).toLocaleDateString()}</span>
                        <span class="score-badge" style="background: ${scoreColor}">${item.overall_score}/10</span>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showEvalDetails(index) {
            const item = allEvaluations[index];
            const container = document.getElementById('eval-details');

            // Highlight active item
            document.querySelectorAll('.eval-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.eval-item')[index].classList.add('active');

            let feedbackHtml = '';
            if (item.detailed_feedback && Array.isArray(item.detailed_feedback)) {
                feedbackHtml = item.detailed_feedback.map(fb => `
                    <div style="margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 12px;">
                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">Q: ${fb.question}</div>
                        <div style="font-size: 13px; color: #444; margin-bottom: 4px;"><strong>Answer:</strong> ${fb.candidate_answer_summary}</div>
                        <div style="font-size: 13px; color: #666;"><em>Feedback: ${fb.feedback}</em> <span style="font-weight:bold; color:${fb.score >= 7 ? 'green' : 'orange'}">(${fb.score}/10)</span></div>
                    </div>
                `).join('');
            } else {
                feedbackHtml = '<p>No detailed feedback available.</p>';
            }

            let transcriptHtml = '';
            if (item.transcript && Array.isArray(item.transcript)) {
                transcriptHtml = item.transcript.map(msg => {
                    const isCandidate = msg.role === 'candidate' || msg.role === 'user';
                    const color = isCandidate ? '#4B53BC' : '#333';
                    const align = isCandidate ? 'right' : 'left';
                    const bg = isCandidate ? '#eef2ff' : '#f5f5f5';
                    return `
                        <div style="margin-bottom: 8px; text-align: ${align};">
                            <div style="display: inline-block; max-width: 80%; text-align: left; background: ${bg}; padding: 8px 12px; border-radius: 8px; font-size: 13px;">
                                <div style="font-weight: bold; color: ${color}; font-size: 11px; margin-bottom: 2px;">${isCandidate ? 'Candidate' : 'Interviewer'}</div>
                                <div>${msg.text}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                transcriptHtml = '<p style="color:#999; font-style:italic;">No transcript available.</p>';
            }

            container.innerHTML = `
                <div style="border-bottom: 1px solid #eee; padding-bottom: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 style="font-size: 20px; margin: 0;">${item.candidate_name}</h2>
                        <span style="background: #eef2ff; color: var(--teams-purple); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                            ${item.recommendation}
                        </span>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <div style="flex: 1; background: #fafafa; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--teams-purple);">${item.overall_score}</div>
                            <div style="font-size: 11px; color: #666;">Overall</div>
                        </div>
                         <div style="flex: 1; background: #fafafa; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #333;">${item.technical_score || '-'}</div>
                            <div style="font-size: 11px; color: #666;">Technical</div>
                        </div>
                         <div style="flex: 1; background: #fafafa; padding: 12px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #333;">${item.communication_score || '-'}</div>
                            <div style="font-size: 11px; color: #666;">Comm.</div>
                        </div>
                    </div>
                    <div>
                        <h4 style="font-size: 14px; margin-bottom: 8px;">Summary</h4>
                        <p style="font-size: 13px; line-height: 1.5; color: #444;">${item.summary || 'No summary provided.'}</p>
                    </div>
                </div>
                
                <div>
                     <h4 style="font-size: 16px; margin-bottom: 12px; border-left: 3px solid var(--teams-purple); padding-left: 8px;">Detailed Feedback</h4>
                     ${feedbackHtml}
                </div>

                <div style="margin-top: 24px;">
                     <h4 style="font-size: 16px; margin-bottom: 12px; border-left: 3px solid #333; padding-left: 8px;">Full Transcript</h4>
                     <div style="background: white; border: 1px solid #eee; border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto;">
                        ${transcriptHtml}
                     </div>
                </div>
            `;
        }

        function filterEvaluations() {
            const query = document.getElementById('eval-search').value.toLowerCase();
            const filtered = allEvaluations.filter(item => item.candidate_name.toLowerCase().includes(query));
            renderEvalList(filtered);
        }

        window.onload = () => {
            fetchRooms();
            const urlParams = new URLSearchParams(window.location.search);
            const r = urlParams.get('room');
            if (r) joinRoom(r);

            // AI Interviewer Form Handler
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('prep-btn');
                    const resumeFile = document.getElementById('resumeInput').files[0];
                    const jdText = document.getElementById('jdInput').value;

                    if (!resumeFile || !jdText) return alert("Please upload a resume and paste the job description.");

                    const originalBtnText = btn.innerText;
                    btn.innerText = "Analyzing Resume... (Please Wait)";
                    btn.disabled = true;
                    btn.style.opacity = "0.7";
                    btn.style.cursor = "not-allowed";

                    const formData = new FormData();
                    formData.append('resume', resumeFile);
                    formData.append('jd', jdText);

                    try {
                        const response = await fetch('/api/upload-resume', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        if (result.status === 'success') {
                            alert(result.message);
                            joinRoom(result.room_id);
                        } else {
                            alert("Error: " + (result.error || "Failed to analyze"));
                        }
                    } catch (e) {
                        console.error(e);
                        alert("Error during upload: " + e.message);
                        btn.innerText = originalBtnText; // Reset button text
                        btn.disabled = false;
                        btn.style.opacity = "1";
                        btn.style.cursor = "pointer";
                    } finally {
                        btn.innerText = "Prepare Interview";
                        btn.disabled = false;
                    }
                };
            }
        };
    </script>
</body>

</html>
